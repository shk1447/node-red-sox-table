<script type="text/javascript">
  (function () {
    RED.nodes.registerType('sox-table', {
      category: 'network',
      color: '#a6bbcf',
      defaults: {
        name: { value: "" },
        url: { value: "", required: true },
        dbtype: { value: "" },
        host: { value: "" },
        port: { value: "" },
        user: { value: "" },
        password: { value: "" },
        database: { value: "" },
        table: { value: "" },
        query: { value: "" },
        options: {
          value: [{ value: '', label: '' }],
          validate: function (v) {
            var unique = new Set(v.map(function (o) { return o.value; }));
            return v.length == unique.size;
          }
        },
      },
      inputs: 0,
      outputs: 1,
      icon: "file.png",
      label: function () {
        return this.name || "sox-table";
      },
      oneditprepare: function () {
        var that = this;

        var tabs = RED.tabs.create({
          id: "func-tabs",
          onchange: function (tab) {
            $("#func-tabs-content").children().hide();
            $("#" + tab.id).show();
          }
        });
        tabs.addTab({
          id: "func-tab-config",
          iconClass: "fa fa-cog",
          label: "DATABASE"
        });
        tabs.addTab({
          id: "func-tab-options",
          iconClass: "fa fa-cog",
          label: "OPTIONS"
        });

        tabs.activateTab("func-tab-config");

        this.editor = RED.editor.createEditor({
          id: 'node-input-query-editor',
          mode: 'ace/mode/sql',
          value: $("#node-input-query").val()
        });
        this.editor.focus();
      },
      oneditsave() {
        $("#node-input-query").val(this.editor.getValue());
        this.editor.destroy();
        delete this.editor;
      },
      oneditcancel: function () {
        this.editor.destroy();
        delete this.editor;
      },
      oneditresize: function (size) {
        var rows = $("#dialog-form>div:not(.node-text-editor-row)");
        var height = $("#dialog-form").height();
        for (var i = 0; i < rows.length; i++) {
          height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-text-editor-row");
        height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
        $(".node-text-editor").css("height", height + "px");
        this.editor.resize();
      }
    });
  })()
</script>

<script type="text/html" data-template-name="sox-table">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row func-tabs-row">
    <ul style="min-width: 600px; margin-bottom: 20px;" id="func-tabs"></ul>
  </div>

  <div id="func-tabs-content" style="min-height: calc(100% - 95px);">
  
    <div id="func-tab-config" style="display:none">
      <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span>URL</span></label>
        <input id="node-input-url" type="text" placeholder="/url">
      </div>

      <div class="form-row">
        <label for="node-input-dbtype"><i class="fa fa-tag"></i> <span>DB TYPE</span></label>
        <select type="text" id="node-input-dbtype" style="width:70%;">
          <option value="pg">PostgreSQL</option>
          <option value="mysql">MYSQL</option>
          <option value="mssql">MSSQL</option>
          <option value="oracledb">ORACLEDB</option>
        </select>
      </div>

      <div class="form-row">
        <label for="node-input-host"><i class="fa fa-tag"></i> HOST</label>
        <input type="text" id="node-input-host" placeholder="127.0.0.1">
      </div>

      <div class="form-row">
        <label for="node-input-port"><i class="fa fa-tag"></i> PORT</label>
        <input type="number" id="node-input-port" placeholder="3306">
      </div>

      <div class="form-row">
        <label for="node-input-user"><i class="fa fa-tag"></i> USER</label>
        <input type="text" id="node-input-user" placeholder="User">
      </div>

      <div class="form-row">
        <label for="node-input-password"><i class="fa fa-tag"></i> PASSWORD</label>
        <input type="password" id="node-input-password" placeholder="Password">
      </div>

      <div class="form-row">
        <label for="node-input-database"><i class="fa fa-tag"></i> DATABASE</label>
        <input type="text" id="node-input-database" placeholder="Database">
      </div>

      <div class="form-row node-text-editor-row">
        <input type="hidden" id="node-input-query" autofocus="autofocus">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-query-editor"></div>
      </div>
    </div>

    <div id="func-tab-options" style="display:none">
    </div>

  </div>
</script>

<script type="text/html" data-help-name="sox-table">
  <p>A simple node that converts the message payloads into all sox-table characters</p>
</script>