<script type="text/javascript">
(function() {
  function resizeDialog(size) {
    size = size || { height: $(".red-ui-tray-content form").height() }
    var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
    var height = size.height;
    for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
    }
    var editorRow = $("#dialog-form>div.node-input-property-container-row");
    height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
    height += 16;
    $("#node-input-property-container").editableList('height',height);
  }

  RED.nodes.registerType('sox-table',{
      category: 'network',
      color: '#a6bbcf',
      defaults: {
          name: {value:""},
          url: {value:"", required:true},
          dbtype: {value:""},
          host: {value:""},
          user: {value:""},
          password: {value:""},
          database: {value:""},
          table: {value:""},
          props:{value:[]},
      },
      inputs:0,
      outputs:1,
      icon: "file.png",
      label: function() {
          return this.name||"sox-table";
      },
      oneditprepare: function() {
        console.log('sox-table debug console')
        $('#node-input-property-container').css('min-height','120px').css('min-width','450px').editableList({
          addItem: function(container,i,opt) {
              var prop = opt;
              if (!prop.hasOwnProperty('p')) {
                  prop = {p:"",v:"",vt:"json"};
              }
              container.css({
                  overflow: 'hidden',
                  whiteSpace: 'nowrap'
              });
              var row = $('<div/>').appendTo(container);

              var propertyName = $('<input/>',{class:"node-input-prop-property-name",type:"text"})
                  .css("width","30%")
                  .appendTo(row)
                  .typedInput({types:['str']});

              $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                  .text('=')
                  .appendTo(row);

              var propertyValue = $('<input/>',{class:"node-input-prop-property-value",type:"text"})
                  .css("width","calc(70% - 30px)")
                  .appendTo(row)
                  .typedInput({default:'json',types:['str','json']});

              propertyName.typedInput('value',prop.p);

              propertyValue.typedInput('value',prop.v);
              propertyValue.typedInput('type',prop.vt);
          },
          removable: true,
          sortable: true
        });

        for (var i=0; i<this.props.length; i++) {
          var prop = this.props[i];
          var newProp = { p: prop.p, v: prop.v, vt: prop.vt };
          if (newProp.v === undefined) {
            if (prop.p === 'payload') {
              newProp.v = this.payload ? this.payload : '';
              newProp.vt = this.payloadType ? this.payloadType : 'date';
            } else if (prop.p === 'topic' && prop.vt === "str") {
              newProp.v =  this.topic ? this.topic : '';
            }
          }
          $("#node-input-property-container").editableList('addItem',newProp);
        }
      },
      oneditsave() {
        var props = $("#node-input-property-container").editableList('items');
        var node = this;
        node.props= [];
        delete node.payloadType;
        delete node.payload;
        node.topic = "";
        props.each(function(i) {
            var prop = $(this);
            var p = {
                p:prop.find(".node-input-prop-property-name").typedInput('value')
            };
            if (p.p) {
                p.v = prop.find(".node-input-prop-property-value").typedInput('value');
                p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
                if (p.p === "payload") { // save payload to old "legacy" property
                    node.payloadType = p.vt;
                    node.payload = p.v;
                    delete p.v;
                    delete p.vt;
                } else if (p.p === "topic" && p.vt === "str") {
                    node.topic = p.v;
                    delete p.v;
                }
                node.props.push(p);
            }
        });
      },
      oneditresize: resizeDialog
  });
})()
</script>

<script type="text/html" data-template-name="sox-table">
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-globe"></i> <span>URL</span></label>
    <input id="node-input-url" type="text" placeholder="/url">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-dbtype"><i class="fa fa-tasks"></i> <span>DB TYPE</span></label>
    <select type="text" id="node-input-dbtype" style="width:70%;">
      <option value="pg">PostgreSQL</option>
      <option value="mysql">MYSQL</option>
      <option value="mssql">MSSQL</option>
      <option value="oracledb">ORACLEDB</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-host"><i class="fa fa-tag"></i> HOST</label>
    <input type="text" id="node-input-host" placeholder="127.0.0.1">
  </div>

  <div class="form-row">
    <label for="node-input-port"><i class="fa fa-tag"></i> PORT</label>
    <input type="number" id="node-input-port" placeholder="3306">
  </div>

  <div class="form-row">
    <label for="node-input-user"><i class="fa fa-tag"></i> USER</label>
    <input type="text" id="node-input-user" placeholder="User">
  </div>

  <div class="form-row">
    <label for="node-input-password"><i class="fa fa-tag"></i> PASSWORD</label>
    <input type="password" id="node-input-password" placeholder="Password">
  </div>

  <div class="form-row">
    <label for="node-input-database"><i class="fa fa-tag"></i> DATABASE</label>
    <input type="text" id="node-input-database" placeholder="Database">
  </div>

  <div class="form-row">
    <label for="node-input-table"><i class="fa fa-tag"></i> TABLE</label>
    <input type="text" id="node-input-table" placeholder="Table Name">
  </div>

  <div class="form-row node-input-property-container-row">
    <ol id="node-input-property-container"></ol>
  </div>
</script>

<script type="text/html" data-help-name="sox-table">
  <p>A simple node that converts the message payloads into all sox-table characters</p>
</script>